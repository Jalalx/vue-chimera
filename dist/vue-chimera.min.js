!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios")):"function"==typeof define&&define.amd?define(["axios"],t):(e=e||self)["vue-chimera"]=t(e.Axios)}(this,function(e){"use strict";function t(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function r(e,t){if(null==e)return{};var r,s,i=function(e,t){if(null==e)return{};var r,s,i={},o=Object.keys(e);for(s=0;s<o.length;s++)r=o[s],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(s=0;s<o.length;s++)r=o[s],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function s(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString(e)}function i(t){if(t&&"function"==typeof t.request)return t;if(s(t))return e.create(t);if("function"==typeof t){return i(t())}return e}e=e&&e.hasOwnProperty("default")?e.default:e;var o=(e,t,r)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let s,i;r=r||{};let o=[];return function(){const n=this,a=arguments;return new Promise(c=>{const h=r.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=r.leading?s:e.apply(n,a);for(c of o)c(t);o=[]},t),h?(s=e.apply(n,a),c(s)):o.push(c)})}};const{CancelToken:n}=e,a="success",c="error",h="cancel",u="loading",l="timeout";class f{static from(e,t={}){if(null==e)throw new Error("Cannot create resource from `null`");if(e instanceof f)return e;if("string"==typeof e)return new f(e,null,t);if(s(e)){const{url:s,method:i}=e,o=r(e,["url","method"]);if(o.cache){if(!t.cache)throw new Error("Pre definition of cache should be on Chimera instance options");if("object"!=typeof o.cache)throw Error("Cache should be an object");let e=Object.create(t.cache);o.cache=Object.assign(e,o.cache)}return new f(s,i,Object.assign({},t,o))}}constructor(e,t,r){if(r=r||{},(t=t?t.toLowerCase():"get")&&-1===["get","post","put","patch","delete"].indexOf(t))throw new Error("Bad Method requested: "+t);if(this.axios=i(r.axios),this.requestConfig={url:e,method:t?t.toLowerCase():"get",headers:r.headers||{},cancelToken:new n(e=>{this._canceler=e}),timeout:r.timeout||void 0},this.requestConfig["get"===this.requestConfig.method?"params":"data"]=r.params,this._loading=!1,this._status=null,this._data=null,this._headers=null,this._error=null,this._lastLoaded=null,this._eventListeners={},this.keepData=!!r.keepData,this.cache=r.cache,this.ssrPrefetched=!1,this.cacheHit=!1,this.prefetch="string"==typeof r.prefetch?r.prefetch.toLowerCase()===t:Boolean(r.prefetch),this.ssrPrefetch=r.ssrPrefetch,this.fetchDebounced=o(this.fetch.bind(this),r.debounce||80,{leading:!0}),r.transformer&&("function"==typeof r.transformer?this.setTransformer(r.transformer):"object"==typeof r.transformer&&(this.setResponseTransformer(r.transformer.response),this.setErrorTransformer(r.transformer.error))),this.responseTransformer=this.responseTransformer||(e=>e),this.errorTransformer=this.errorTransformer||(e=>e),r.interval&&this.startInterval(r.interval),"object"==typeof r.on&&r.on)for(let e in r.on)this.on(e,r.on[e])}setResponseTransformer(e){this.responseTransformer=e}setErrorTransformer(e){this.errorTransformer=e}setTransformer(e){this.responseTransformer=e,this.errorTransformer=e}startInterval(e){"undefined"!=typeof process&&process.server||(e&&(this._interval=e),this.stopInterval(),this._interval_id=setInterval(()=>this.reload(!0),this._interval))}stopInterval(){this._interval_id&&clearInterval(this._interval_id)}on(e,t){let r=this._eventListeners[e]||[];return r.push(t),this._eventListeners[e]=r,this}bindListeners(e){Object.keys(this._eventListeners).forEach(t=>{(this._eventListeners[t]||[]).forEach((r,s)=>{this._eventListeners[t][s]=r.bind(e)})})}emit(e){(this._eventListeners[e]||[]).forEach(e=>{e(this)})}fetch(t,r){return new Promise((s,i)=>{if(this.cache&&!t){let e=this.cache.assignCache(this);if(e)return this.cacheHit=!0,s(e._data)}this._loading=!0,this.emit(u);let o=Object.assign({},this.requestConfig,"object"==typeof r?{["get"===this.requestConfig.method?"params":"data"]:r}:{});this.axios.request(o).then(e=>{this._error=null,this._loading=!1,this._lastLoaded=new Date,this._status=e.status,this._data=e.data?this.responseTransformer(e.data):null,this._headers=e.headers||{},this.cache&&this.cache.set(this),this.emit(a),s(this._data)}).catch(t=>{this._data=null,this._loading=!1;const r=t.response;if(r?(this._status=r.status,this._error=r.data=!r.data||this.errorTransformer(r.data),this._headers=r.headers||{}):(this._status=0,this._error=!0,this._headers={}),this.cache&&"network-first"===this.cache.strategy)return this.cache.assignCache(this),this.cacheHit=!0,s(this._data);t.message&&!t.response&&-1!==t.message.indexOf("timeout")?(t.timeout=!0,this.emit(l)):e.isCancel(t)?(t.cancel=!0,this.emit(h)):this.emit(c),i(t)})})}reload(e){return this.fetchDebounced(e)}execute(){return this.fetchDebounced(!0)}send(e){return this.fetchDebounced(!0,e)}cancel(e){this.stopInterval(),e&&(this._data=null),"function"==typeof this._canceler&&this._canceler(),this.requestConfig.cancelToken=new n(e=>{this._canceler=e})}stop(){this.cancel()}toJSON(){const e={};return["_loading","_status","_data","_headers","_error","_lastLoaded","ssrPrefetched"].forEach(t=>{e[t]=this[t]}),e}get loading(){return this._loading}get status(){return this._status}get data(){return this._data}get headers(){return this._headers}get error(){return this._error}get lastLoaded(){return this._lastLoaded}}class d extends f{fetch(e){return Promise.reject(new Error("Null Resource"))}cancel(){}get loading(){return!1}get status(){return 0}get data(){return null}get error(){return null}get lastLoaded(){return null}}class m{constructor(e){if("undefined"!=typeof window){const t=String(e.store).replace(/[\s-]/g).toLowerCase();this.storage="sessionstorage"===t?window.sessionStorage:window.localStorage}if(!this.storage)throw Error("LocalStorageCache: Local storage is not available.");this.defaultExpiration=e.defaultExpiration||6e4}getObjectStore(){const e=this.storage.getItem("_chimera");return e?JSON.parse(e):{}}setObjectStore(e){this.storage.setItem("_chimera",JSON.stringify(e))}clear(){this.storage.removeItem("_chimera")}setItem(e,t,r){const s=this.getObjectStore();s[e]={expiration:Date.now()+(r||this.defaultExpiration),value:t},this.setObjectStore(s)}getItem(e){let t=this.getObjectStore()[e];return t&&t.value&&Date.now()<=t.expiration?t.value:(this.removeItem(e),null)}removeItem(e){const t=this.getObjectStore();delete t[e],this.setObjectStore(t)}keys(){return Object.keys(this.getObjectStore())}length(){return this.keys().length}}class p{static from(e,t){if(!e)return null;let{store:r}=e;return new p(t,e.strategy||"stale",r)}constructor(e,t,r){this.strategy=t,this.store=r,this.vm=e}get(e){return this.store.getItem(this.getCacheKey(e))}set(e,t){delete(t=t||e.toJSON()).ssrPrefetched,this.store.setItem(this.getCacheKey(e),t)}assignCache(e,t){t||(t=this.get(e));const r=this.strategy,s=()=>{Object.assign(e,t)};if(t){if("cache-first"===r)return s(),e;if("network-first"===this.strategy){if("undefined"!=typeof navigator&&!navigator.onLine||!0===e.error)return s(),e}else"stale"===this.strategy&&s()}}clear(){this.store&&this.store.clear()}getCacheKey(e){const t="undefined"!=typeof window?window.btoa:e=>e;return"$_chimera_"+this.vm._uid+t([e.requestConfig.url,e.requestConfig.params,e.requestConfig.data,e.requestConfig.method].join("|"))}set store(e){this._store=e&&"object"==typeof e?e:new m({store:e})}get store(){return this._store}}class _{constructor(e,t,r){this._vm=e,this._reactiveResources={},this.options=r||{},this.axios=this.options.axios=!this.options.axios&&this._vm.$axios?this._vm.$axios:i(this.options.axios),this.options.cache&&(this.cache=this.options.cache=p.from(this.options.cache,this._vm));const s=this._vm.$options;s.computed=s.computed||{},s.watch=s.watch||{},t=Object.assign({},t);for(let e in t){if("$"===e.charAt(0)||!t.hasOwnProperty(e))continue;let r=t[e];"function"==typeof r?(r=r.bind(this._vm),t[e]=new d,this._reactiveResources[e]=r,s.computed["$_chimera__"+e]=r,s.watch["$_chimera__"+e]=(t=>this.updateReactiveResource(e,t))):t[e]=f.from(r,this.options),s.computed[e]=(()=>t[e]),t[e].bindListeners(this._vm)}Object.defineProperty(t,"$cancelAll",{value:this.cancelAll.bind(this)}),Object.defineProperty(t,"$axios",{get:()=>this.axios}),Object.defineProperty(t,"$loading",{get(){for(let e in this)if(e.loading)return!0;return!1}}),this.resources=t}updateReactiveResources(){Object.keys(this._reactiveResources).forEach(e=>{this.updateReactiveResource(e)})}updateReactiveResource(e){const t=this.resources[e];t.stopInterval();let r=f.from(this._reactiveResources[e].call(this._vm),this.options);t.keepData&&(r._data=t._data,r._status=t._status,r._headers=t._headers,r._error=t._error),r._lastLoaded=t._lastLoaded,r.prefetch&&r.reload(),this.resources[e]=r}cancelAll(){Object.keys(this.resources).forEach(e=>{this.resources[e].cancel()})}}var g=(e={})=>({beforeCreate(){const i=this.$options;let o;if(!i.chimera||i._chimera)return;if("function"==typeof i.chimera&&(i.chimera=i.chimera.call(this)),i.chimera instanceof _)o=i.chimera;else if(s(i.chimera)){const s=i.chimera,{$options:n}=s,a=r(s,["$options"]);o=new _(this,a,function(e){for(var r=1;r<arguments.length;r++){var s=null!=arguments[r]?arguments[r]:{},i=Object.keys(s);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),i.forEach(function(r){t(e,r,s[r])})}return e}({},e,n))}i.computed=i.computed||{},i.watch=i.watch||{};const n="undefined"!=typeof process&&process.server&&this.$ssrContext?this.$ssrContext.nuxt:"undefined"!=typeof window?window.__NUXT__:null;if(o&&n&&n.chimera)try{if(this.$router){let e=this.$router.match(this.$router.currentRoute.fullPath);(e?e.matched:[]).forEach((e,t)=>{let r=n.chimera[t];r&&Object.keys(o.resources).forEach(e=>{let t=o.resources[e],s=r[e];t&&s&&s._data&&["_data","_status","_headers","ssrPrefetched","_lastLoaded"].forEach(e=>{t[e]=s[e]})})})}}catch(e){}this._chimera=o},data(){return this._chimera?{$chimera:this._chimera.resources}:{}},mounted(){if(this._chimera){this._chimera.updateReactiveResources();for(let e in this._chimera.resources){let t=this._chimera.resources[e];!t.prefetch||t.ssrPrefetched&&"override"!==t.ssrPrefetch||t.reload()}}},beforeDestroy(){this._chimera&&(this._chimera.cancelAll(),this._chimera=null,delete this._chimera)}});const b={options:{axios:null,cache:null,debounce:80,prefetch:"get",ssrPrefetch:!0,ssrPrefetchTimeout:4e3,transformer:null,headers:null},install(e,t={}){Object.keys(t).forEach(e=>{e in this.options&&(this.options[e]=t[e])}),e.prototype.hasOwnProperty("$chimera")||Object.defineProperty(e.prototype,"$chimera",{get(){return this._chimera?this._chimera.resources:null}}),e.mixin(g(this.options))},NuxtPlugin:function(){this.options=this.options||{};const e=this.options;return function({beforeNuxtRender:t,isDev:s,$axios:i}){if(!t)return;const o=[];t((...t)=>new Promise((n,a)=>{(async function({Components:t,nuxtState:n}){n.chimera=n.chimera||{};for(let a=0,c=t.length;a<c;a++){let c=t[a],h=c.options?c.options.chimera:null;if("function"==typeof h&&(i&&!c.$axios&&(c.$axios=i),h=h.bind(c)()),!h)continue;const u={},{$options:l}=h,d=r(h,["$options"]),m=Object.assign({},e,l);m.axios||(m.axios=i);for(let e in d){let t=d[e];if(t&&"function"!=typeof t){if(t=t&&t._data?t:f.from(t,m),o.push(t.cancel.bind(t)),!t.prefetch||!t.ssrPrefetch)continue;try{s&&console.log("  Prefetching: "+t.requestConfig.url);let e=await t.execute();t._data=e.data}catch(e){s&&console.error(e.message)}t.ssrPrefetched=!0,d[e]=u[e]=t}}Object.keys(u).length&&(n.chimera[a]=u)}})(...t).then(n).catch(a),setTimeout(a,e.ssrPrefetchTimeout,new Error("  SSR Prefetch Timeout."))}).catch(e=>{for(let e of o)"function"==typeof e&&e();s&&console.error(e.message)}))}}};let y=null;return"undefined"!=typeof window?y=window.Vue:"undefined"!=typeof global&&(y=global.Vue),y&&y.use(b,b.options),b});
//# sourceMappingURL=vue-chimera.min.js.map
