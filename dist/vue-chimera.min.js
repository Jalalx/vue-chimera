!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("axios"),require("vue")):"function"==typeof define&&define.amd?define(["axios","vue"],t):e.vueChimera=t(e.Axios,e.Vue)}(this,function(e,t){"use strict";function r(e,t){if(null==e)return{};var r,s,i=function(e,t){if(null==e)return{};var r,s,i={},n=Object.keys(e);for(s=0;s<n.length;s++)r=n[s],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(s=0;s<n.length;s++)r=n[s],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function s(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString(e)}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;class i{constructor(e){if("undefined"==typeof window||!window.localStorage)throw Error("LocalStorageCache: Local storage is not available.");this.storage=window.localStorage,this.defaultExpiration=e}setItem(e,t,r){this.storage.setItem(e,JSON.stringify({expiration:Date.now()+(r||this.defaultExpiration),value:t}))}getItem(e){let t=this.storage.getItem(e);return(t=JSON.parse(t))&&t.value&&Date.now()<=t.expiration?t.value:(this.removeItem(e),null)}removeItem(e){this.storage.removeItem(e)}keys(){return Object.keys(this.storage)}all(){return this.keys().reduce((e,t)=>(e[t]=this.storage.getItem(t),e),{})}length(){return this.keys().length}clearCache(){this.storage.clear()}}class n{setItem(e,t,r){}getItem(e){return null}removeItem(e){}keys(){return[]}all(){return{}}length(){return 0}clearCache(){}}var o=(e,t,r)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let s,i;r=r||{};let n=[];return function(){const o=this,a=arguments;return new Promise(c=>{const h=r.leading&&!i;clearTimeout(i),i=setTimeout(()=>{i=null;const t=r.leading?s:e.apply(o,a);for(c of n)c(t);n=[]},t),h?(s=e.apply(o,a),c(s)):n.push(c)})}};const{CancelToken:a}=e,c="success",h="error",u="cancel",l="loading";class f{static from(e,t={}){if(null==e)throw new Error("Cannot create resource from `null`");if(e instanceof f)return e;if("string"==typeof e)return new f(e,"get",t);if(s(e)){const{url:s,method:i}=e,n=r(e,["url","method"]);return new f(s,i,Object.assign({},t,n))}}constructor(t,r,i){if(i=i||{},(r=r?r.toLowerCase():"get")&&-1===["get","post","put","patch","delete"].indexOf(r))throw new Error("Bad Method requested: "+r);if(this.axios=function(t){if(t instanceof e)return t;if(t&&"function"==typeof t.$request)return t;if(s(t))return e.create(t);if("function"==typeof t){let r=t();if(r instanceof e)return r}return e}(i.axios),this.requestConfig={url:t,method:r?r.toLowerCase():"get",headers:i.headers||{},cancelToken:new a(e=>{this._canceler=e})},this.requestConfig["get"===this.requestConfig.method?"params":"data"]=i.params,this._loading=!1,this._status=null,this._data=null,this._headers=null,this._error=null,this._lastLoaded=null,this._eventListeners={},this.ssrPrefetched=!1,this.prefetch="string"==typeof i.prefetch?i.prefetch.toLowerCase()===r:Boolean(i.prefetch),this.ssrPrefetch=i.ssrPrefetch,this.cache=this.getCache(i.cache),this.fetchDebounced=o(this.fetch.bind(this),i.debounce||80,{leading:!0}),i.transformer?"function"==typeof i.transformer?this.setTransformer(i.transformer):"object"==typeof i.transformer&&(this.setResponseTransformer(i.transformer.response),this.setErrorTransformer(i.transformer.error)):(this.errorTransformer=(e=>e),this.responseTransformer=(e=>e)),i.interval&&this.setInterval(i.interval),"object"==typeof i.on&&i.on)for(let e in i.on)this.on(e,i.on[e])}setResponseTransformer(e){this.responseTransformer=e}setErrorTransformer(e){this.errorTransformer=e}setTransformer(e){this.responseTransformer=e,this.errorTransformer=e}setInterval(e){"undefined"!=typeof process&&process.server||(this._interval=e,this._interval_id&&clearInterval(this._interval_id),this._interval_id=setInterval(()=>this.reload(!0),e))}on(e,t){let r=this._eventListeners[e]||[];return r.push(t),this._eventListeners[e]=r,this}emit(e){(this._eventListeners[e]||[]).forEach(e=>{e(this)})}fetch(t){return new Promise((r,s)=>{let i=e=>{this._error=null,this._loading=!1,e&&(this._status=e.status,this._data=this.responseTransformer(e.data),this._headers=e.headers,this._lastLoaded=new Date)};if(this.cache&&!t){let e=this.cache.getItem(this.getCacheKey());if(e)return i(e),void r(e)}this._loading=!0,this.emit(l),this.axios.request(this.requestConfig).then(e=>{i(e),this.setCache(e),this.emit(c),r(e)}).catch(t=>{this._data=null,this._loading=!1;const r=t.response;r&&(this._status=r.status,this._error=this.errorTransformer(r.data),this._headers=r.headers),e.isCancel(t)?this.emit(u):this.emit(h),s(t)})})}reload(e){return this.fetchDebounced(e)}execute(){return this.fetchDebounced(!0)}send(){return this.fetchDebounced(!0)}cancel(e){e&&(this._data=null),"function"==typeof this._canceler&&this._canceler(),this.requestConfig.cancelToken=new a(e=>{this._canceler=e})}stop(){this.cancel()}getCache(e){const t={"no-cache":()=>new n,localStorage:()=>new i(this.getConfig().cacheExpiration||1e4)};return t[e=e||"no-cache"]?t[e]():null}getCacheKey(){return("undefined"!=typeof window&&"undefined"!=typeof btoa?window.btoa:e=>e)(this.requestConfig.url+this.requestConfig.params+this.requestConfig.data+this.requestConfig.method)}setCache(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}get loading(){return this._loading}get status(){return this._status}get data(){return this._data}get headers(){return this._headers}get error(){return this._error}get lastLoaded(){return this._lastLoaded}}class d extends f{fetch(e){return Promise.reject(new Error("Null Resource"))}cancel(){}get loading(){return!1}get status(){return 0}get data(){return null}get error(){return null}get lastLoaded(){return null}}class m{constructor(e,t){let{resources:s}=e,i=r(e,["resources"]);this._vm=null,this._listeners=[],this._context=t,this._reactiveResources={},this.options=i,s=Object.assign({},s);for(let e in s){let t=s[e];"function"==typeof t?(s[e]=new d,this._reactiveResources[e]=t.bind(this._context)):s[e]=f.from(t,this.options)}this._initVM(s),this._resources=s}_initVM(e){this._vm=new t({data:e,computed:{$loading(){for(let e in this.$data)if(this.$data[e].loading)return!0;return!1}}}),Object.defineProperty(e,"$loading",{get:()=>this._vm.$loading}),Object.defineProperty(e,"$axios",{get:()=>f.config?f.config.axios:null}),Object.defineProperty(e,"$cancelAll",{value:()=>this.cancelAll()})}watch(){return this._watcher||(this._watcher=this._vm.$watch("$data",()=>{let e=this._listeners.length;for(;e--;){let t=this._listeners[e];t&&t.$nextTick(()=>t.$forceUpdate())}},{deep:!0})),this._watcher}subscribe(e){this._listeners.push(e)}unsubscribe(e){!function(e,t){if(e.length){const r=e.indexOf(t);if(r>-1)e.splice(r,1)}}(this._listeners,e)}updateReactiveResources(){for(let e in this._reactiveResources)this.updateReactiveResource(e)}updateReactiveResource(e){let t=this._resources[e]=f.from(this._reactiveResources[e](),this.options);t.prefetch&&t.reload()}cancelAll(){Object.keys(this._resources).forEach(e=>{this._resources[e].cancel()})}get resources(){return this._resources}}var p=(e={})=>({beforeCreate(){const t=this.$options;let r;if(!t.chimera||t._chimera)return;if(t.chimera instanceof m)r=t.chimera;else if("function"==typeof t.chimera){let s=t.chimera.bind(this)();r=s instanceof m?s:new m(Object.assign({},e,s),this)}else s(t.chimera)&&(r=new m(Object.assign({},e,t.chimera),this));this._chimeraWatcher=r.watch(),r.subscribe(this),t.computed=t.computed||{},t.watch=t.watch||{};for(let e in r.resources)t.computed[e]=function(){return this.$chimera[e]};for(let e in r._reactiveResources)t.computed["__"+e]=r._reactiveResources[e],t.watch["__"+e]=(()=>r.updateReactiveResource(e));const i="undefined"!=typeof process&&process.server&&this.$ssrContext?this.$ssrContext.nuxt:"undefined"!=typeof window?window.__NUXT__:null;if(r&&i&&i.chimera&&this.$router){let e=this.$router.match(this.$router.currentRoute.fullPath);(e?e.matched:[]).forEach((e,t)=>{let s=i.chimera[t];s&&Object.keys(r.resources).forEach(e=>{let t=r.resources[e],i=s[e];t&&i&&i._data&&["_data","_status","_headers","ssrPrefetched","_lastLoaded"].forEach(e=>{t[e]=i[e]})})}),process.client&&delete i.chimera}this.$chimera=r.resources,this._chimera=r},mounted(){if(this._chimera){this._chimera.updateReactiveResources();for(let e in this._chimera._resources){let t=this._chimera._resources[e];!t.prefetch||t.ssrPrefetched&&"override"!==t.ssrPrefetch||t.reload()}}},beforeDestroy(){this._chimera&&(this._chimera.unsubscribe(this),this._chimera.cancelAll(),this._chimeraWatcher&&(this._chimeraWatcher(),delete this._chimeraWatcher),this._chimera=null)}});t.config.silent=!0,t.config.productionTip=!1,t.config.devtools=!1;const g={options:{axios:null,cache:"no-cache",debounce:80,prefetch:"get",ssrPrefetch:!0,ssrPrefetchTimeout:4e3},install(e,t={}){Object.assign(this.options,t),e.mixin(p(this.options))},NuxtPlugin:function(){this.options=this.options||{};const e=this.options;return function({beforeNuxtRender:t,isDev:s,$axios:i}){if(!t)return;const n=[];t((...t)=>new Promise((o,a)=>{(async function({Components:t,nuxtState:o}){o.chimera=o.chimera||{};for(let a=0,c=t.length;a<c;a++){let c=t[a],h=c.options?c.options.chimera:null;if("function"==typeof h&&(i&&!c.$axios&&(c.$axios=i),h=h.bind(c)()),!h)continue;const u={},{resources:l}=h,d=r(h,["resources"]);for(let t in l){let r=l[t];if(r&&"function"!=typeof r){if(r=r&&r._data?r:f.from(r,Object.assign({},e,d)),n.push(r.cancel.bind(r)),!r.prefetch||!r.ssrPrefetch)continue;try{s&&console.log("  Prefetching: "+r.requestConfig.url);let e=await r.execute();r._data=e.data}catch(e){s&&console.error(e.message)}r.ssrPrefetched=!0,l[t]=u[t]=r}}Object.keys(u).length&&(o.chimera[a]=u)}})(...t).then(o).catch(a),setTimeout(a,e.ssrPrefetchTimeout,new Error("  SSR Prefetch Timeout."))}).catch(e=>{for(let e of n)"function"==typeof e&&e();s&&console.error(e.message)}))}}};let _=null;return"undefined"!=typeof window?_=window.Vue:"undefined"!=typeof global&&(_=global.Vue),_&&_.use(g,g.options),g});
//# sourceMappingURL=vue-chimera.min.js.map
