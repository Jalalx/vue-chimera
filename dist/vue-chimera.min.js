!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("vue"),require("axios")):"function"==typeof define&&define.amd?define(["vue","axios"],t):(e=e||self)["vue-chimera"]=t(e.Vue,e.Axios)}(this,function(e,t){"use strict";function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function s(e,t){if(null==e)return{};var r,s,o=function(e,t){if(null==e)return{};var r,s,o={},i=Object.keys(e);for(s=0;s<i.length;s++)r=i[s],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)r=i[s],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function o(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString(e)}function i(e){if(e instanceof t)return e;if(e&&"function"==typeof e.$request)return e;if(o(e))return t.create(e);if("function"==typeof e){if("function"==typeof e.request)return e;let r=e();if(r instanceof t)return r}return t}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t;class n{constructor(e){if("undefined"==typeof window||!window.localStorage)throw Error("LocalStorageCache: Local storage is not available.");this.storage=window.localStorage,this.defaultExpiration=e}setItem(e,t,r){this.storage.setItem(e,JSON.stringify({expiration:Date.now()+(r||this.defaultExpiration),value:t}))}getItem(e){let t=this.storage.getItem(e);return(t=JSON.parse(t))&&t.value&&Date.now()<=t.expiration?t.value:(this.removeItem(e),null)}removeItem(e){this.storage.removeItem(e)}keys(){return Object.keys(this.storage)}all(){return this.keys().reduce((e,t)=>(e[t]=this.storage.getItem(t),e),{})}length(){return this.keys().length}clearCache(){this.storage.clear()}}class a{setItem(e,t,r){}getItem(e){return null}removeItem(e){}keys(){return[]}all(){return{}}length(){return 0}clearCache(){}}var c=(e,t,r)=>{if(!Number.isFinite(t))throw new TypeError("Expected `wait` to be a finite number");let s,o;r=r||{};let i=[];return function(){const n=this,a=arguments;return new Promise(c=>{const h=r.leading&&!o;clearTimeout(o),o=setTimeout(()=>{o=null;const t=r.leading?s:e.apply(n,a);for(c of i)c(t);i=[]},t),h?(s=e.apply(n,a),c(s)):i.push(c)})}};const{CancelToken:h}=t,u="success",l="error",f="cancel",d="loading";class p{static from(e,t={}){if(null==e)throw new Error("Cannot create resource from `null`");if(e instanceof p)return e;if("string"==typeof e)return new p(e,"get",t);if(o(e)){const{url:r,method:o}=e,i=s(e,["url","method"]);return new p(r,o,Object.assign({},t,i))}}constructor(e,t,r,s){if(r=r||{},this._context=s,(t=t?t.toLowerCase():"get")&&-1===["get","post","put","patch","delete"].indexOf(t))throw new Error("Bad Method requested: "+t);if(this.axios=i(r.axios),this.requestConfig={url:e,method:t?t.toLowerCase():"get",headers:r.headers||{},cancelToken:new h(e=>{this._canceler=e})},this.requestConfig["get"===this.requestConfig.method?"params":"data"]=r.params,this._loading=!1,this._status=null,this._data=null,this._headers=null,this._error=null,this._lastLoaded=null,this._eventListeners={},this.ssrPrefetched=!1,this.prefetch="string"==typeof r.prefetch?r.prefetch.toLowerCase()===t:Boolean(r.prefetch),this.ssrPrefetch=r.ssrPrefetch,this.cache=this.getCache(r.cache),this.fetchDebounced=c(this.fetch.bind(this),r.debounce||80,{leading:!0}),r.transformer?"function"==typeof r.transformer?this.setTransformer(r.transformer):"object"==typeof r.transformer&&(this.setResponseTransformer(r.transformer.response),this.setErrorTransformer(r.transformer.error)):(this.errorTransformer=(e=>e),this.responseTransformer=(e=>e)),r.interval&&this.setInterval(r.interval),"object"==typeof r.on&&r.on)for(let e in r.on)this.on(e,r.on[e])}setResponseTransformer(e){this.responseTransformer=e}setErrorTransformer(e){this.errorTransformer=e}setTransformer(e){this.responseTransformer=e,this.errorTransformer=e}setInterval(e){"undefined"!=typeof process&&process.server||(this._interval=e,this._interval_id&&clearInterval(this._interval_id),this._interval_id=setInterval(()=>this.reload(!0),e))}on(e,t){let r=this._eventListeners[e]||[];return r.push(t),this._eventListeners[e]=r,this}emit(e){(this._eventListeners[e]||[]).forEach(e=>{e.call(this._context)})}fetch(e){return new Promise((r,s)=>{let o=e=>{this._error=null,this._loading=!1,e&&(this._status=e.status,this._data=this.responseTransformer(e.data),this._headers=e.headers,this._lastLoaded=new Date)};if(this.cache&&!e){let e=this.cache.getItem(this.getCacheKey());if(e)return o(e),void r(e)}this._loading=!0,this.emit(d),this.axios.request(this.requestConfig).then(e=>{o(e),this.setCache(e),this.emit(u),r(e)}).catch(e=>{this._data=null,this._loading=!1;const r=e.response;r&&(this._status=r.status,this._error=this.errorTransformer(r.data),this._headers=r.headers),t.isCancel(e)?this.emit(f):this.emit(l),s(e)})})}reload(e){return this.fetchDebounced(e)}execute(){return this.fetchDebounced(!0)}send(){return this.fetchDebounced(!0)}cancel(e){e&&(this._data=null),"function"==typeof this._canceler&&this._canceler(),this.requestConfig.cancelToken=new h(e=>{this._canceler=e})}stop(){this.cancel()}getCache(e){const t={"no-cache":()=>new a,localStorage:()=>new n(this.getConfig().cacheExpiration||1e4)};return t[e=e||"no-cache"]?t[e]():null}getCacheKey(){return("undefined"!=typeof window&&"undefined"!=typeof btoa?window.btoa:e=>e)(this.requestConfig.url+this.requestConfig.params+this.requestConfig.data+this.requestConfig.method)}setCache(e){this.cache&&this.cache.setItem(this.getCacheKey(),e)}toJSON(){const e={};return["_loading","_status","_data","_headers","_error","_lastLoaded","ssrPrefetched"].forEach(t=>{e[t]=this[t]}),JSON.stringify(e)}get loading(){return this._loading}get status(){return this._status}get data(){return this._data}get headers(){return this._headers}get error(){return this._error}get lastLoaded(){return this._lastLoaded}}class m extends p{fetch(e){return Promise.reject(new Error("Null Resource"))}cancel(){}get loading(){return!1}get status(){return 0}get data(){return null}get error(){return null}get lastLoaded(){return null}}class g{constructor(e,t,r){this._vm=e,this._reactiveResources={},this.options=r||{},this.axios=this.options.axios=!this.options.axios&&this._vm.$axios?this._vm.$axios:i(this.options.axios);const s=this._vm.$options;s.computed=s.computed||{},s.watch=s.watch||{},t=Object.assign({},t);for(let e in t){if("$"===e.charAt(0))continue;let r=t[e];"function"==typeof r?(r=r.bind(this._vm),t[e]=new m,this._reactiveResources[e]=r,s.computed["__"+e]=r,s.watch["__"+e]=(t=>this.updateReactiveResource(e,t))):t[e]=p.from(r,this.options,this._vm,this),s.computed[e]=(()=>t[e])}Object.defineProperty(t,"$cancelAll",{value:this.cancelAll.bind(this)}),Object.defineProperty(t,"$axios",{get:()=>this.axios}),Object.defineProperty(t,"$loading",{get(){for(let e in this)if(e.loading)return!0;return!1}}),this.resources=t}updateReactiveResources(){for(let e in this._reactiveResources)this.updateReactiveResource(e)}updateReactiveResource(e){let t=p.from(this._reactiveResources[e].call(this._vm),this.options,this);this.resources[e].keepData&&["_status","_data","_headers","_error"].forEach(e=>{t[e]=this.resources[e]}),t._lastLoaded=this.resources[e]._lastLoaded,t.prefetch&&t.reload(),this.resources[e]=t}cancelAll(){Object.keys(this.resources).forEach(e=>{this.resources[e].cancel()})}}var _=(e={})=>({beforeCreate(){const t=this.$options;let i;if(!t.chimera||t._chimera)return;if("function"==typeof t.chimera&&(t.chimera=t.chimera.call(this)),t.chimera instanceof g)i=t.chimera;else if(o(t.chimera)){const o=t.chimera,{$options:n}=o,a=s(o,["$options"]);i=new g(this,a,function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},o=Object.keys(s);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),o.forEach(function(t){r(e,t,s[t])})}return e}({},e,n))}t.computed=t.computed||{},t.watch=t.watch||{};const n="undefined"!=typeof process&&process.server&&this.$ssrContext?this.$ssrContext.nuxt:"undefined"!=typeof window?window.__NUXT__:null;if(i&&n&&n.chimera)try{if(this.$router){let e=this.$router.match(this.$router.currentRoute.fullPath);(e?e.matched:[]).forEach((e,t)=>{let r=n.chimera[t];r&&Object.keys(i.resources).forEach(e=>{let t=i.resources[e],s=r[e];t&&s&&s._data&&["_data","_status","_headers","ssrPrefetched","_lastLoaded"].forEach(e=>{t[e]=s[e]})})})}}catch(e){}this._chimera=i},data(){return this._chimera?{$chimera:this._chimera.resources}:{}},mounted(){if(this._chimera){this._chimera.updateReactiveResources();for(let e in this._chimera.resources){let t=this._chimera.resources[e];!t.prefetch||t.ssrPrefetched&&"override"!==t.ssrPrefetch||t.reload()}}},beforeDestroy(){this._chimera&&(this._chimera.cancelAll(),this._chimera=null,delete this._chimera)}});e.config.silent=!0,e.config.productionTip=!1,e.config.devtools=!1;const y={options:{axios:null,cache:"no-cache",debounce:80,prefetch:"get",ssrPrefetch:!0,ssrPrefetchTimeout:4e3,transformer:null,headers:null},install(e,t={}){Object.keys(t).forEach(e=>{e in this.options&&(this.options[e]=t[e])}),e.prototype.hasOwnProperty("$chimera")||Object.defineProperty(e.prototype,"$chimera",{get(){return this._chimera?this._chimera.resources:null}}),e.mixin(_(this.options))},NuxtPlugin:function(){this.options=this.options||{};const e=this.options;return function({beforeNuxtRender:t,isDev:r,$axios:o}){if(!t)return;const i=[];t((...t)=>new Promise((n,a)=>{(async function({Components:t,nuxtState:n}){n.chimera=n.chimera||{};for(let a=0,c=t.length;a<c;a++){let c=t[a],h=c.options?c.options.chimera:null;if("function"==typeof h&&(o&&!c.$axios&&(c.$axios=o),h=h.bind(c)()),!h)continue;const u={},{$options:l}=h,f=s(h,["$options"]),d=Object.assign({},e,l);d.axios||(d.axios=o);for(let e in f){let t=f[e];if(t&&"function"!=typeof t){if(t=t&&t._data?t:p.from(t,d),i.push(t.cancel.bind(t)),!t.prefetch||!t.ssrPrefetch)continue;try{r&&console.log("  Prefetching: "+t.requestConfig.url);let e=await t.execute();t._data=e.data}catch(e){r&&console.error(e.message)}t.ssrPrefetched=!0,f[e]=u[e]=t}}Object.keys(u).length&&(n.chimera[a]=u)}})(...t).then(n).catch(a),setTimeout(a,e.ssrPrefetchTimeout,new Error("  SSR Prefetch Timeout."))}).catch(e=>{for(let e of i)"function"==typeof e&&e();r&&console.error(e.message)}))}}};let w=null;return"undefined"!=typeof window?w=window.Vue:"undefined"!=typeof global&&(w=global.Vue),w&&w.use(y,y.options),y});
//# sourceMappingURL=vue-chimera.min.js.map
